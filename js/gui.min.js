!function(e){var t=[],a=[],n=[],o=[],i={},s=function(e,t){return void 0!==t&&(e=t.selector+" "+e),$(e+".template").clone(!0).removeClass("template")},r=function(e,t){if($(t).empty(),!(e instanceof Item))return!1;var n=s(".itembox"),o=e.rarityIdent();n.addClass(o),$("#item_rarities option[value='"+o.toUpperCase()+"']").prop("selected",!0);var i=s(".itembox-statsgroup",n),r=i.clone();return $(".itemboxheader .itemName",n).text(e.itemName()),$(".itemboxheader .baseName",n).text(e.baseName()),r.append(e.itemclassIdent().toLowerCase().ucfirst()),r.append("<br>",$.map(e.getTagsWithProps(a),function(e){return e.Id.underscoreToHuman()}).join(", ")),$.each(e.localStats(),function(e,t){r.append("<br>",e,": ","<span class='text-value'>"+t+"</span>")}),$(".itembox-stats",n).append(r),r=i.clone(),r.append("Requires ",$.map(e.requirements(),function(e,t){return t+" <span class='text-value'>"+e+"</span>"}).join(", "),"<br>"),r.append(s(".ilvl",n).val(e.item_level)),$(".itembox-stats",n).append(r),r=i.clone(),$.each(["implicits","affixes"],function(t,a){$(".itembox-stats",n).append(r),r=i.clone();var o=s("ul.mods",n);o.addClass(a),$.each(e[a](),function(e,t){var a=s("li.mod",o);a.data("primary",t.getProp("Rows")),a.addClass("mod-type-"+t.modType()),a.addClass(t.serialize().klass),$(".name",a).text(t.name()),$.each(t.t().split("\n"),function(e,t){$("ul.stats",a).append("<li>"+t+"</li>")}),a.appendTo(o)}),$(".stats li",o).length>0&&o.appendTo(r)}),$(".itembox-stats",n).append(r),$("#used_baseitem").append(n)},c=function(e,t){console.log(e,"@",t,"?");var a=$("#available_mods tbody.clicked");if(!(e instanceof ModGenerator))return console.log("mod_generator needs to be of type ModGenerator"),!1;if(!(t instanceof Item))return console.log("baseitem needs to be of type BaseItem"),!1;var n=ApplicableMod.APPLICABLE_BYTE.LOWER_ILVL|ApplicableMod.APPLICABLE_BYTE.DOMAIN_FULL|ApplicableMod.APPLICABLE_BYTE.ALREADY_PRESENT|MasterMod.APPLICABLE_BYTE.NO_MULTIMOD|ApplicableMod.APPLICABLE_BYTE.ABOVE_LLD_LEVEL,o=e.mods(t,n),i=Spawnable.calculateSpawnchance($.grep(o,function(e){return e.isPrefix()})),r=Spawnable.calculateSpawnchance($.grep(o,function(e){return e.isSuffix()})),c=Spawnable.calculateSpawnchance($.grep(o,function(e){return e.isImplicit()}));return l(i,$("#prefixes")),l(r,$("#suffixes")),$("#implicits tbody tr:not(.template)").remove(),$("#implicits caption .count").text(c.length),$.each(c,function(e,t){var a=s("#implicits tbody tr.mod"),n=t.serialize();a.attr("id",t.domId());var o=t.applicableByteHuman();a.attr("data-applicable_byte",o.bits.join("-"));var i={strings:[]};Spawnable.implementedBy(t)&&(i=t.spawnableByteHuman(),a.attr("data-spawnable-byte",i.bits.join("-")),$(".spawn_chance",a).text(t.humanSpawnchance())),a.prop("title",o.strings.concat(i.strings).join(" and ")),$(".ilvl",a).text(t.getProp("Level")),$(".stats",a).text(t.t()),$(".spawn_chance",a).text(t.humanSpawnchance()),a.data("mod",n),a.addClass(n.klass),a.addClass(t.modType()),a.prop("title")&&$(".add_mod",a).remove(),a.appendTo("#implicits")}),$("#implicits").trigger("update"),$("#implicits").trigger("sorton",[[[0,1]]]),$.each(i.concat(r),function(e,t){t.rollableCached()&&$("#correct-group-"+t.getProp("CorrectGroup")).removeClass("not_rollable")}),a.each(function(){$("#"+$(this).attr("id")).trigger("click")}),!0},l=function(e,t){$("tbody:not(.template)",t).remove(),$("caption .count",t).text(e.length),$.each(e,function(e,a){var n=s("tbody.mods.template .mod",t),o=a.serialize();n.attr("id",a.domId());var i=a.getProp("CorrectGroup"),r=$("tbody.mods[data-correct-group='"+i+"']",t);if(!r.length){var c=s("tbody.correct_group",t);r=s("tbody.mods",t).hide(),c.attr("id","correct-group-"+i),r.attr("data-correct-group",i),$("th.correct_group",c).text(a.correctGroupTranslated()),t.append(c,r)}var l=a.applicableByteHuman();n.attr("data-applicable_byte",l.bits.join("-"));var p={strings:[]};Spawnable.implementedBy(a)&&(p=a.spawnableByteHuman(),n.attr("data-spawnable-byte",p.bits.join("-")),$(".spawn_chance",n).text(a.humanSpawnchance())),n.prop("title",l.strings.concat(p.strings).join(" and ")),$(".ilvl",n).text(a.getProp("Level")),$(".name",n).text(a.name()),$(".stats",n).text(a.t()),n.data("mod",o),n.prop("title")&&$(".add_mod",n).remove(),n.addClass(o.klass),n.addClass(a.modType()),r.append(n)}),t.trigger("update"),t.trigger("sorton",[[[0,1]]])},p=function(e,t){return e instanceof Item?void $("ul.currencies .applicable input.ModGenerator:radio").each(function(){var a=$(this),n=a.parents(".applicable"),o=ModGeneratorFactory.build(a.val(),t);a.prop("disabled",!o.applicableTo(e));var i=o.applicableByteHuman();n.attr("title",i.strings.join(" and ")),n.attr("data-applicable_byte",i.bits.join("-"))}):!1};$.when($.getJSON("js/data/mods.json",function(e){t=e,Mod.mods=t}),$.getJSON("js/data/tags.json",function(e){a=e,$(a).each(function(e,t){i[t.Id.toUpperCase()]=+t.Rows})}),$.getJSON("js/data/baseitemtypes.json",function(e){n=e}),$.getJSON("js/data/stats.json",function(e){o=e,Mod.all_stats=o}),$.getJSON("js/data/translations/English/stat_descriptions.json",function(e){Mod.localization=new Localization(e)}),$.getJSON("js/data/meta_data.json",function(e){Item.meta_data=e}),$.getJSON("js/data/craftingbenchoptions.json",function(e){MasterMod.craftingbenchoptions=e}),$.getJSON("js/data/translations/English/mod_correct_groups.json",function(e){Mod.correct_group_localization=e})).then(function(){console.log("loaded "+t.length+" mods","loaded "+a.length+" tags","loaded "+n.length+" baseitemtypes","loaded "+o.length+" stats");var i=null,l=null,d=function(){var e=$("input.ModGenerator:radio:checked");return e.hasClass("Masterbench")?new Masterbench(t,+e.data("npc_master_key")):ModGeneratorFactory.build($("input.ModGenerator:radio:checked").val(),t)};ByteSet.initLocalization($("#legends"));var m=function(){var t=$("#baseitems option:selected").data("baseitem_primary");if(t===e)return null;var a=n[t];if(a===e)return console.log("could not find",t),null;var o=new Item(a),i=$("#used_baseitem input.ilvl:not(.template)");return i.length&&(o.item_level=+i.val()),o};$.each(Item.ITEMCLASSES,function(e,t){var a=s("#item_classes option");a.text(e),a.data("ident",e),a.appendTo("#item_classes")}),$("#item_classes").on("change",function(){var e=$("option:selected",this),t=Item.ITEMCLASSES[e.data("ident")];if(null===t)return!1;var a=$.map(n,function(e){return t.PRIMARY===+e.ItemClass?e:null});$("#baseitems option:not(.template)").remove(),$.each(a,function(e,t){var a=s("#baseitems option");a.text(t.Name),a.data("baseitem_primary",t.primary),a.appendTo("#baseitems")}),$("#baseitems option.template").prop("selected",!0),$("#baseitems").trigger("change")}),$("#baseitems").on("change",function(){l=m(),r(l,"#used_baseitem"),c(i,l),p(l,t)}),$("input.ModGenerator:radio").on("change",function(){i=d(),c(i,l);var e=$("#craftingbenchoptions");$(".craftingbenchoption:not(.template)",e).remove(),i instanceof Masterbench&&($.each(i.craftingbenchoptions,function(t,a){if($("#"+Mod.domId(a.ModsKey)).length){var n=s(".craftingbenchoption",e);n.val(t),n.text(a.Name),e.append(n)}}),$("#no_craftingbenchoptions").toggle(0===$(".craftingbenchoption:not(.template)").length),$("option:last",e).prop("selected",!0))}),$("#use_mod_gen").on("click",function(){var e;return console.log(i,"@",l),i instanceof ModGenerator?l instanceof Item?(e=[l],i instanceof Masterbench&&e.push(+$("#craftingbenchoptions option:selected").val()),i.applyTo.apply(i,e)&&(r(l,"#used_baseitem"),c(i,l),p(l,t)),!0):(console.log("baseitem needs to be of type Item"),!1):(console.log("mod_generator needs to be of type ModGenerator"),!1)}),$("#available_mods tbody.correct_group").on("click",function(){$(this).toggleClass("clicked").next().toggle()}),$("#implicits-caption").on("click",function(){$(this).toggleClass("clicked").parents("table").children("tbody").toggle()}),$("#prefixes, #suffixes, #implicits").tablesorter({cssInfoBlock:"tablesorter-no-sort"}),$(".add_mod").on("click",function(){var e=$(this).parents("tr").data("mod"),a=ModFactory.deserialize(e);null===a&&console.log("could not deserialize",e),console.log(l,"+",a),l.addMod(a)&&(r(l,"#used_baseitem"),c(i,l),p(l,t))}),$(".remove_mod").on("click",function(){var e=$(this).parents(".mod");l.removeMod(l.getMod(e.data("primary"))),r(l,"#used_baseitem"),c(i,l)}),$("input.ilvl").on("change",function(){l.item_level=+$(this).val(),c(i,l)}),$("#item_rarities").on("change",function(){l.rarity=Item.RARITY[$("option:selected",this).val()],r(l,"#used_baseitem"),c(i,l),p(l,t)}),$("#item_classes option:not(.template)").filter(function(){return"armour"===$(this).text().toLowerCase()}).prop("selected",!0),$("#item_classes").trigger("change"),$("#baseitems option:not(.template)").filter(":first").prop("selected",!0),$("#baseitems").trigger("change"),$("input.ModGenerator:radio").filter(":first").prop("checked",!0),$("input.ModGenerator:radio").filter(":checked").trigger("change"),$("#use_mod_gen").trigger("click")})}();